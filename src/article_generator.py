from openai import AsyncOpenAI
import random
import asyncio
from . import config

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
client = AsyncOpenAI(api_key=config.OPENAI_API_KEY)

async def generate_article_and_summary(posts: list) -> tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ª–æ–Ω–≥-—Ä–∏–¥ –≤ HTML –∏ –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å—Ç–æ–≤."""
    if not posts:
        return "", ""

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç—ã –¥–ª—è –ø–æ–¥–∞—á–∏ –≤ –º–æ–¥–µ–ª—å
    formatted_posts = ""
    for post in posts:
        text = post[1]
        source_link = post[2]
        has_media = "true" if post[3] else "false" # –ü–æ–ª—É—á–∞–µ–º —Ñ–ª–∞–≥ has_media
        formatted_posts += f"<post>\n<content>{text}</content>\n<source>{source_link}</source>\n<has_media>{has_media}</has_media>\n</post>\n\n"

    system_prompt = """
    **–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ IT-–∏–∑–¥–∞–Ω–∏—è.** **–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∏—Ö –≤ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–æ–Ω–≥-—Ä–∏–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ Telegra.ph.** **–ê—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã, –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∏ —ç–Ω—Ç—É–∑–∏–∞—Å—Ç—ã.**

    **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ª–æ–Ω–≥-—Ä–∏–¥—É (HTML –¥–ª—è Telegra.ph):**
    **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏:**

    <h3>, <h4> ‚Äî –¥–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ **(–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <h1>, <h2>)**
    <p> ‚Äî –¥–ª—è –∞–±–∑–∞—Ü–µ–≤
    <strong> –∏–ª–∏ <b> ‚Äî –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
    <em> –∏–ª–∏ <i> ‚Äî –¥–ª—è –∫—É—Ä—Å–∏–≤–∞
    <a href="url"> ‚Äî –¥–ª—è —Å—Å—ã–ª–æ–∫
    <ul>, <ol>, <li> ‚Äî –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
    <blockquote> ‚Äî –¥–ª—è —Ü–∏—Ç–∞—Ç
    <br> ‚Äî –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
    <pre> ‚Äî –¥–ª—è –∫–æ–¥–∞

    **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:**

    **–ó–∞–≥–æ–ª–æ–≤–æ–∫: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <h1> –∏–ª–∏ <h2>** ‚Äî –Ω–∞—á–∏–Ω–∞–π —Å—Ä–∞–∑—É —Å –≤–≤–æ–¥–Ω–æ–≥–æ –∞–±–∑–∞—Ü–∞ –≤ <p>, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç —è—Ä–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞–π–¥–∂–µ—Å—Ç–∞
    –†–∞–∑–¥–µ–ª—ã: –ò—Å–ø–æ–ª—å–∑—É–π <h3> –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–º, <h4> –¥–ª—è –ø–æ–¥—Ç–µ–º
    –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞ <h3>, –∑–∞—Ç–µ–º –∏–∑–ª–∞–≥–∞–π –Ω–æ–≤–æ—Å—Ç–∏ –≤ <p>. –ù–µ –∫–æ–ø–∏—Ä—É–π, –∞ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π
    **–ò—Å—Ç–æ—á–Ω–∏–∫–∏: –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –∞–±–∑–∞—Ü–∞ —Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É:** <a href="[source_link]">[1]</a>
    **–ú–µ–¥–∏–∞: –ï—Å–ª–∏ –µ—Å—Ç—å <has_media>true</has_media>, —É–ø–æ–º–∏–Ω–∞–π:** "(—Å–º. –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –ø–æ—Å—Ç–µ)" –∏–ª–∏ "(–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ –≤–∏–¥–µ–æ)". **–ù–µ –ø—ã—Ç–∞–π—Å—è –æ–ø–∏—Å–∞—Ç—å —Å–∞–º–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏ –Ω–∞ –µ–≥–æ –Ω–∞–ª–∏—á–∏–µ.**
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π <strong> –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ <em> –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

    ***–í–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:***

    **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <html>, <head>, <body>, <h1>, <h2>**
    **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <div>, <span>, <section>**
    **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∞—Ç—Ä–∏–±—É—Ç—ã —Å—Ç–∏–ª–µ–π (style=)**
    **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <img> —Ç–µ–≥–∏**
    **–ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –ø—Ä—è–º–æ–π –≤—Å—Ç–∞–≤–∫–µ –≤ Telegra.ph**

    **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫—Ä–∞—Ç–∫–æ–º—É —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é (summary):**

    **–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–æ–Ω—Å–∞ –≤ Telegram (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)**
    –ü–µ—Ä–µ—á–∏—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –¥–∞–π–¥–∂–µ—Å—Ç–∞

    **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
    [HTML-–∫–æ–¥ –±–µ–∑ —Ç–µ–≥–æ–≤ html/head/body]
    ---SUMMARY---
    [–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–ª—è Telegram]
    –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
    html<p><strong>üöÄ IT-–¥–∞–π–¥–∂–µ—Å—Ç: –ì–ª–∞–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ–¥–µ–ª–∏</strong></p>

    <h3>üî• –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h3>
    <p>–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º... <a href="https://example.com">[1]</a></p>

    <h3>üíº –ë–∏–∑–Ω–µ—Å –∏ —Å—Ç–∞—Ä—Ç–∞–ø—ã</h3>
    <p>–î—Ä—É–≥–∞—è –Ω–æ–≤–æ—Å—Ç—å... <a href="https://example2.com">[2]</a></p>
    """

    try:
        response = await client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"–í–æ—Ç –ø–æ–¥–±–æ—Ä–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é:\n\n{formatted_posts}"}
            ],
            temperature=0.6,
            max_tokens=10000
        )
        await asyncio.sleep(random.uniform(1, 3))
        content = response.choices[0].message.content
        if '---SUMMARY---' in content:
            article_html, summary = content.split('---SUMMARY---', 1)
            return article_html.strip(), summary.strip()
        else:
            return content.strip(), "–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–µ –±—ã–ª–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ."

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI: {e}")
        return {"article": "", "summary": ""} 