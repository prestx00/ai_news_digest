# AI News Digest Bot

Этот проект представляет собой автоматизированную систему для сбора, анализа и публикации еженедельного дайджеста новостей. Архитектура проекта позволяет запускать несколько независимых ботов из одной кодовой базы, каждый со своей конфигурацией, тематикой и базой данных.

## Архитектура

Приложение состоит из следующих модулей:

1.  **`telegram_parser.py`**: Собирает посты из Telegram-каналов, указанных в конфигурации, с помощью **Telethon**.
2.  **`database.py`**: Хранит собранные посты в **SQLite** базе данных. Имя файла базы данных задается в конфигурации.
3.  **`article_generator.py`**: Использует **OpenAI API** для анализа постов и генерации уникального лонг-рида и краткого содержания на основе кастомного промпта из конфигурации.
4.  **`telegraph_publisher.py`**: Публикует сгенерированную статью на платформе **Telegra.ph**.
5.  **`telegram_notifier.py`**: Отправляет уведомление со ссылкой на статью в заданный Telegram-чат.
6.  **`main.py`**: Главный файл, который запускает весь процесс по расписанию с помощью **APScheduler**. Принимает аргумент командной строки `--config` для выбора файла конфигурации.
7.  **`config.py`**: Модуль для загрузки и управления конфигурацией из `.env` файлов.
8.  **`check_session.py`**: Скрипт для проверки валидности сессии Telethon.

## Установка и запуск

### 1. Клонируйте репозиторий
```bash
git clone <your-repo-url>
cd ai_news_digest
```

### 2. Создайте и активируйте виртуальное окружение
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. Установите зависимости
```bash
pip install -r requirements.txt
```

### 4. Настройте конфигурацию

Система использует `.env` файлы для конфигурации каждого бота. Вы можете создать несколько таких файлов для запуска разных инстансов.

1.  **Создайте файлы конфигурации.** Например, для AI-бота и HR-бота:
    ```bash
    cp .env.example .env.ai
    cp .env.example .env.hr
    ```

2.  **Заполните переменные** в каждом файле (`.env.ai`, `.env.hr` и т.д.):
    *   `API_ID`, `API_HASH`: Ваши учетные данные из [my.telegram.org](https://my.telegram.org).
    *   `BOT_TOKEN`: Токен Telegram-бота от [@BotFather](https://t.me/BotFather).
    *   `CHAT_ID`: ID целевого Telegram-канала или чата (например, `@my_channel`).
    *   `OPENAI_API_KEY`: Ваш ключ от OpenAI.
    *   `TELEGRAM_CHANNELS`: Список каналов для парсинга, через запятую (например, `channel1,channel2`).
    *   `DB_NAME`: Имя файла для базы данных SQLite (например, `ai_news.db`). **Должно быть уникальным для каждого бота.**
    *   `ARTICLE_PROMPT`: Системный промпт для OpenAI, определяющий стиль и структуру генерируемой статьи.
    *   `SCHEDULE_DAY_OF_WEEK`: День недели для запуска (например, `mon`, `tue`, `wed`, `thu`, `fri`, `sat`, `sun`).
    *   `SCHEDULE_HOUR`: Час запуска (0-23).
    *   `SCHEDULE_MINUTE`: Минута запуска (0-59).
    *   `TELEGRAM_PARSE_LIMIT`: Количество последних постов, которые нужно проверять в каждом канале.

### 5. Первая авторизация Telethon (создание сессии)

При первом запуске Telethon попросит вас авторизоваться. Это нужно сделать для каждого инстанса, который использует новый номер телефона.

*   Дважды запустите скрипт в режиме инициализации, указав нужный конфиг:
    ```bash
    # для AI-бота
    python main.py --config .env.ai --init-session
    
    # для HR-бота
    python main.py --config .env.hr --init-session
    ```
*   Введите номер телефона и код из Telegram. Будет создан файл сессии (например, `ai.session` для `.env.ai`).

### 6. Запуск бота

Вы можете запустить любого из настроенных ботов, указав его файл конфигурации.

```bash
# Запустить AI-бота
python main.py --config .env.ai

# Запустить HR-бота в другом терминале
python main.py --config .env.hr
```

## Развертывание на сервере (Production)

Для обеспечения постоянной работы бота на сервере рекомендуется использовать `systemd`. Это позволит запускать бота как службу, управлять его жизненным циклом (запуск, остановка, перезапуск) и автоматически запускать его при старте системы.

### 1. Создание файла службы Systemd

Создайте файл службы для вашего бота. Рекомендуется использовать имя, отражающее название бота и конфигурацию, например, `/etc/systemd/system/ai_news_digest_ai.service` для бота, использующего `.env.ai`.

```ini
[Unit]
Description=AI News Digest Bot for .env.ai
After=network.target

[Service]
User=<ваш_пользователь> # Например, root или другой пользователь, от имени которого будет работать бот
WorkingDirectory=/path/to/your/ai_news_digest # Абсолютный путь к корневой директории проекта
ExecStart=/usr/bin/python3 /path/to/your/ai_news_digest/main.py --config .env.ai
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**Важные моменты:**
*   Замените `<ваш_пользователь>` на имя пользователя, от имени которого будет запускаться служба (например, `root` или созданный вами пользователь).
*   Замените `/path/to/your/ai_news_digest` на **абсолютный путь** к директории, где находится ваш проект `ai_news_digest`.
*   Убедитесь, что путь к `python3` (`/usr/bin/python3`) корректен для вашей системы. Если вы используете виртуальное окружение, путь может быть `/path/to/your/ai_news_digest/venv/bin/python3`.
*   Если у вас несколько конфигураций (например, `.env.hr`), создайте отдельный файл службы для каждой из них (например, `/etc/systemd/system/ai_news_digest_hr.service`), изменив `Description` и `ExecStart` соответствующим образом.

### 2. Управление службой Systemd

После создания или изменения файла службы выполните следующие команды:

*   **Перезагрузка конфигурации Systemd:**
    Необходимо после каждого изменения файла `.service`, чтобы `systemd` увидел новые настройки.
    ```bash
    sudo systemctl daemon-reload
    ```

*   **Включение службы (добавление в автозагрузку):**
    Это гарантирует, что бот будет автоматически запускаться при старте сервера.
    ```bash
    sudo systemctl enable ai_news_digest_ai.service
    ```

*   **Запуск службы:**
    ```bash
    sudo systemctl start ai_news_digest_ai.service
    ```

*   **Остановка службы:**
    ```bash
    sudo systemctl stop ai_news_digest_ai.service
    ```

*   **Перезапуск службы:**
    Полезно после обновления кода бота или изменения `.env` файла.
    ```bash
    sudo systemctl restart ai_news_digest_ai.service
    ```

*   **Проверка статуса службы:**
    ```bash
    sudo systemctl status ai_news_digest_ai.service
    ```
    Вы должны увидеть `Active: active (running)`.

*   **Просмотр логов службы:**
    Для отладки и мониторинга работы бота.
    ```bash
    sudo journalctl -u ai_news_digest_ai.service -f
    ```
    Это позволит отслеживать логи бота в реальном времени. Ищите сообщения о запуске планировщика, парсинге, генерации статьи, публикации и отправке уведомлений.

### 3. Проверка работы бота

После запуска службы убедитесь, что бот функционирует корректно:

*   **Проверьте логи службы `journalctl`:** Ищите сообщения о выполнении задач (парсинг, генерация, публикация, уведомления) и отсутствие ошибок.
*   **Проверьте Telegram-чат:** Убедитесь, что уведомления с дайджестом приходят в указанный чат.
*   **Проверьте Telegra.ph:** Перейдите по ссылке из уведомления, чтобы убедиться, что статья опубликована и доступна.
*   **Проверьте базу данных:** Используйте `sqlite3` для проверки количества обработанных и необработанных постов. Например:
    ```bash
    sqlite3 <ИМЯ_ВАШЕЙ_БАЗЫ_ДАННЫХ.db> "SELECT COUNT(*) FROM posts WHERE is_processed = 0;"
    ```
    (Замените `<ИМЯ_ВАШЕЙ_БАЗЫ_ДАННЫХ.db>` на актуальное имя файла вашей базы данных, например, `news.db` или `hr_news.db`).
